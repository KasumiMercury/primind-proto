syntax = "proto3";

package throttle.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "common/v1/common.proto";

option go_package = "gen/throttle/v1;throttlev1";

// Lane represents the throttling lane classification
enum Lane {
  LANE_UNSPECIFIED = 0;
  LANE_STRICT = 1;
  LANE_LOOSE = 2;
}

// ThrottleResultItem represents the result for processing a single remind
message ThrottleResultItem {
  string remind_id = 1;
  string task_id = 2;
  common.v1.TaskType task_type = 3;
  repeated string fcm_tokens = 4;
  bool success = 5;
  string error = 6;
  Lane lane = 7;
  google.protobuf.Timestamp original_time = 8;
  google.protobuf.Timestamp scheduled_time = 9;
  bool was_shifted = 10;
  bool skipped = 11;
  string skip_reason = 12;
}

// ThrottleResponse is the response from throttle processing
message ThrottleResponse {
  int32 processed_count = 1;
  int32 success_count = 2;
  int32 failed_count = 3;
  repeated ThrottleResultItem results = 4;
  int32 skipped_count = 5;
  int32 shifted_count = 6;
}

// NotificationTask is the internal task structure for registering notifications
message NotificationTask {
  repeated string fcm_tokens = 1;
  string task_id = 2;
  common.v1.TaskType task_type = 3;
  google.protobuf.Timestamp schedule_at = 4;
}

// CancelRemindRequest is sent when a remind is cancelled
message CancelRemindRequest {
  string task_id = 1 [(buf.validate.field).string.uuid = true];
  string user_id = 2 [(buf.validate.field).string.uuid = true];
  int64 deleted_count = 3 [(buf.validate.field).int64.gte = 0];
  google.protobuf.Timestamp cancelled_at = 4;
  // List of remind IDs that were deleted, used to cancel queued notifications
  repeated string remind_ids = 5;
}

// CancelRemindResponse is returned after processing cancellation
message CancelRemindResponse {
  bool success = 1;
  string message = 2;
}

// ErrorResponse for error responses
message ErrorResponse {
  string error = 1;
  string message = 2;
}

// PlanResultItem represents the result for planning a single remind
message PlanResultItem {
  string remind_id = 1;
  string task_id = 2;
  common.v1.TaskType task_type = 3;
  Lane lane = 4;
  google.protobuf.Timestamp original_time = 5;
  google.protobuf.Timestamp planned_time = 6;
  bool was_shifted = 7;
  bool skipped = 8;
  string skip_reason = 9;
}

// PlanResponse is the response from the planning phase
message PlanResponse {
  int32 planned_count = 1;
  int32 skipped_count = 2;
  int32 shifted_count = 3;
  repeated PlanResultItem results = 4;
}
